<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BMS Analyzer Local</title>
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --border: #475569;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 span {
      font-size: 2rem;
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
    }

    .nav-tab {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-tab:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Model Selection */
    .model-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .model-section h3 {
      margin-bottom: 15px;
      font-size: 1rem;
      color: var(--text-secondary);
    }

    .model-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .model-option {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .model-option:hover {
      border-color: var(--accent);
    }

    .model-option.selected {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }

    .model-option.recommended {
      position: relative;
    }

    .model-option.recommended::after {
      content: '‚òÖ Recommended';
      position: absolute;
      top: -10px;
      right: 10px;
      background: var(--success);
      color: white;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .model-name {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .model-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .cost-estimate {
      margin-top: 15px;
      padding: 15px;
      background: var(--bg-card);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cost-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .cost-value {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--success);
    }

    /* Upload Section */
    .upload-zone {
      background: var(--bg-secondary);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 60px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 30px;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }

    .upload-zone h2 {
      margin-bottom: 10px;
      font-size: 1.4rem;
    }

    .upload-zone p {
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .upload-zone input[type="file"] {
      display: none;
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--accent-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-card);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
    }

    .btn-danger {
      background: var(--error);
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* Status Messages */
    .status {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.loading {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid var(--accent);
    }

    .status.success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid var(--success);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid var(--error);
    }

    .status.duplicate {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid var(--warning);
    }

    /* Result Card */
    .result-card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }

    .result-header h3 {
      font-size: 1.2rem;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .badge.normal {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .badge.warning {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .badge.critical {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }

    .metric {
      background: var(--bg-card);
      padding: 15px;
      border-radius: 8px;
    }

    .metric-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .metric-value.negative {
      color: var(--error);
    }

    .metric-value.positive {
      color: var(--success);
    }

    /* History Table */
    .history-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
    }

    .history-table th,
    .history-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .history-table th {
      background: var(--bg-card);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-transform: uppercase;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, color 0.2s;
      white-space: nowrap;
    }

    .history-table th:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .history-table th.sorted {
      background: var(--accent);
      color: white;
    }

    .history-table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .history-table tr:last-child td {
      border-bottom: none;
    }

    /* Settings */
    .settings-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .settings-section h3 {
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .form-group input, .form-group select {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 15px;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group .help-text {
      margin-top: 5px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .key-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }

    .key-status.configured {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .key-status.missing {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state h3 {
      margin-bottom: 10px;
    }

    /* Alerts */
    .alerts-list {
      margin-top: 15px;
    }

    .alert-item {
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .alert-item.warning {
      background: rgba(245, 158, 11, 0.2);
      border-left: 3px solid var(--warning);
    }

    .alert-item.critical {
      background: rgba(239, 68, 68, 0.2);
      border-left: 3px solid var(--error);
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress Bar */
    .progress-container {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    #progress-title {
      font-weight: 600;
      font-size: 1.1rem;
    }

    #progress-percent {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--accent);
    }

    .progress-bar-outer {
      background: var(--bg-primary);
      border-radius: 8px;
      height: 24px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-bar-inner {
      background: linear-gradient(90deg, var(--accent), #22c55e);
      height: 100%;
      border-radius: 8px;
      transition: width 0.3s ease;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .progress-stats span {
      padding: 4px 10px;
      background: var(--bg-card);
      border-radius: 4px;
    }

    #progress-cost {
      color: var(--success);
      font-weight: 600;
    }

    .progress-phase {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Cost display in results */
    .cost-info {
      margin-top: 15px;
      padding: 10px 15px;
      background: var(--bg-card);
      border-radius: 6px;
      display: flex;
      gap: 20px;
      font-size: 0.85rem;
    }

    .cost-info span {
      color: var(--text-secondary);
    }

    .cost-info strong {
      color: var(--success);
    }

    /* Refresh Status Bar */
    .refresh-status-bar {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px 20px;
      min-width: 350px;
      max-width: 450px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .refresh-status-bar.hidden {
      transform: translateY(100px);
      opacity: 0;
      pointer-events: none;
    }

    .refresh-status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .refresh-status-title {
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-status-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
      line-height: 1;
    }

    .refresh-status-close:hover {
      color: var(--text-primary);
    }

    .refresh-status-phases {
      margin-bottom: 10px;
    }

    .refresh-phase {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .refresh-phase.active {
      color: var(--text-primary);
    }

    .refresh-phase.complete {
      color: var(--success);
    }

    .refresh-phase.error {
      color: var(--error);
    }

    .refresh-phase-icon {
      width: 18px;
      text-align: center;
    }

    .refresh-progress-bar {
      height: 4px;
      background: var(--bg-card);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 10px;
    }

    .refresh-progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .refresh-status-message {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    .refresh-status-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .refresh-status-actions .btn {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    /* Small spinner for inline use */
    .spinner-small {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-tabs {
        flex-wrap: wrap;
      }

      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .model-grid {
        grid-template-columns: 1fr;
      }

      .history-table {
        font-size: 0.85rem;
      }

      .history-table th,
      .history-table td {
        padding: 8px 10px;
      }

      .refresh-status-bar {
        left: 20px;
        right: 20px;
        min-width: auto;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><span>üîã</span> BMS Analyzer Local</h1>
      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="upload">Upload</button>
        <button class="nav-tab" data-tab="history">History</button>
        <button class="nav-tab" data-tab="settings">Settings</button>
      </div>
    </header>

    <!-- Upload Tab -->
    <div id="upload-tab" class="tab-content active">
      <div id="status" class="status"></div>

      <!-- Progress Bar (hidden until upload starts) -->
      <div id="progress-container" class="progress-container" style="display: none;">
        <div class="progress-header">
          <span id="progress-title">Processing...</span>
          <span id="progress-percent">0%</span>
        </div>
        <div class="progress-bar-outer">
          <div id="progress-bar" class="progress-bar-inner" style="width: 0%"></div>
        </div>
        <div class="progress-stats">
          <span id="progress-count">0 / 0</span>
          <span id="progress-rate">0/sec</span>
          <span id="progress-eta">ETA: --</span>
          <span id="progress-cost">$0.00</span>
        </div>
        <div id="progress-phase" class="progress-phase"></div>
      </div>

      <!-- Auto-Verify Info -->
      <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.5rem;">üî¨</span>
          <div>
            <strong>Smart Verification</strong>
            <div style="color: var(--text-secondary); font-size: 0.85em;">
              Parallel processing ‚Ä¢ Auto-skips complete records ‚Ä¢ Physics validation ‚Ä¢ Data sanitization
            </div>
          </div>
        </div>
      </div>

      <div class="upload-zone" id="upload-zone">
        <h2>üì∏ Drop BMS Screenshots or ZIP Here</h2>
        <p>Supports images (PNG, JPG, WebP) and ZIP files with multiple images</p>
        <button class="btn">Select Files</button>
        <input type="file" id="file-input" accept="image/*,.zip" multiple>
      </div>

      <div id="result-container"></div>
    </div>

    <!-- History Tab -->
    <div id="history-tab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Analysis History</h2>
        <div>
          <button class="btn btn-secondary" id="refresh-btn" onclick="startBackgroundRefresh()">üîÑ Refresh</button>
          <button class="btn" onclick="exportCSV()">üì• Export CSV</button>
        </div>
      </div>

      <div id="history-container">
        <div class="empty-state">
          <h3>No data yet</h3>
          <p>Upload some BMS screenshots to get started</p>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <h2 style="margin-bottom: 20px;">Settings</h2>

      <div class="settings-section">
        <h3>üîë API Keys</h3>
        <form autocomplete="off" onsubmit="return false;">
          <!-- Hidden username field for accessibility (prevents browser warning) -->
          <input type="text" name="username" autocomplete="username" style="display:none;" aria-hidden="true">
          <div class="form-group">
            <label>Gemini API Key (Required)</label>
            <div id="gemini-status" class="key-status missing">
              ‚ùå Not configured
            </div>
            <input type="password" id="gemini-key" placeholder="Enter your Gemini API key" autocomplete="new-password">
            <p class="help-text">Get your key from <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: var(--accent);">Google AI Studio</a></p>
            <div class="btn-row">
              <button type="button" class="btn" onclick="saveGeminiKey()">Save Key</button>
              <button type="button" class="btn btn-danger" onclick="deleteGeminiKey()">Delete Key</button>
            </div>
          </div>

          <div class="form-group">
            <label>OpenWeatherMap API Key (Optional - for weather data)</label>
            <div id="weather-status" class="key-status missing">
              ‚ùå Not configured
            </div>
            <input type="password" id="weather-key" placeholder="Enter your OpenWeatherMap API key" autocomplete="new-password">
            <p class="help-text">Get your key from <a href="https://openweathermap.org/api" target="_blank" style="color: var(--accent);">OpenWeatherMap</a></p>
            <div class="btn-row">
              <button type="button" class="btn" onclick="saveWeatherKey()">Save Key</button>
              <button type="button" class="btn btn-danger" onclick="deleteWeatherKey()">Delete Key</button>
            </div>
          </div>
        </form>
      </div>

      <div class="settings-section">
        <h3>ü§ñ Default Model</h3>
        <div class="form-group">
          <label>Model for Analysis</label>
          <select id="default-model">
            <!-- Options loaded dynamically -->
          </select>
          <p class="help-text">This model will be used by default. You can override it per-upload on the Upload tab.</p>
        </div>
        <button class="btn" onclick="saveDefaultModel()">Save Default Model</button>
      </div>

      <div class="settings-section">
        <h3>üìç Location (for weather data)</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="form-group">
            <label>Latitude</label>
            <input type="number" id="latitude" step="any" placeholder="19.442831">
          </div>
          <div class="form-group">
            <label>Longitude</label>
            <input type="number" id="longitude" step="any" placeholder="-154.943977">
          </div>
        </div>
        <button class="btn" onclick="saveLocation()">Save Location</button>
      </div>

      <div class="settings-section">
        <h3>üìÅ Output</h3>
        <div class="form-group">
          <label>CSV File Path</label>
          <input type="text" id="csv-path" readonly style="background: var(--bg-primary); cursor: default;">
        </div>
      </div>

      <div class="settings-section">
        <h3>üìä Column Visibility</h3>
        <p class="help-text" style="margin-bottom: 15px;">Choose which columns to display in the History table</p>
        <div id="column-toggles" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;">
          <!-- Column toggles loaded dynamically -->
        </div>
        <div class="btn-row" style="margin-top: 15px;">
          <button class="btn" onclick="saveColumnSettings()">Save Column Settings</button>
          <button class="btn btn-secondary" onclick="resetColumnSettings()">Reset to Default</button>
        </div>
      </div>

      <div class="settings-section">
        <h3>üî¨ Data Re-Analysis</h3>
        <p class="help-text" style="margin-bottom: 15px;">Re-analyze records that are missing temperature or other extraction data</p>
        <div id="reanalysis-status" style="margin-bottom: 15px; padding: 15px; background: var(--bg-card); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>Loading status...</span>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn" onclick="runReanalysis()" id="reanalysis-run-btn">üîÑ Run Re-Analysis</button>
          <button class="btn btn-secondary" onclick="checkReanalysisStatus()">üìä Check Status</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let selectedModel = 'gemini-2.0-flash-lite';
    let models = [];

    // Column visibility configuration - ALL visible by default
    const ALL_COLUMNS = [
      { id: 'time', label: 'Time', default: true, sortKey: 'timestampFromFilename', sortType: 'date' },
      { id: 'systemId', label: 'System ID', default: true, sortKey: 'hardwareSystemId', sortType: 'string' },
      { id: 'fileName', label: 'File Name', default: false, sortKey: 'fileName', sortType: 'string' },
      { id: 'soc', label: 'SOC %', default: true, sortKey: 'stateOfCharge', sortType: 'number' },
      { id: 'voltage', label: 'Voltage', default: true, sortKey: 'overallVoltage', sortType: 'number' },
      { id: 'current', label: 'Current', default: true, sortKey: 'current', sortType: 'number' },
      { id: 'power', label: 'Power', default: true, sortKey: 'power', sortType: 'number' },
      { id: 'capacity', label: 'Capacity', default: true, sortKey: 'remainingCapacity', sortType: 'number' },
      { id: 'cycles', label: 'Cycles', default: true, sortKey: 'cycleCount', sortType: 'number' },
      { id: 'highCell', label: 'High Cell', default: false, sortKey: 'highestCellVoltage', sortType: 'number' },
      { id: 'lowCell', label: 'Low Cell', default: false, sortKey: 'lowestCellVoltage', sortType: 'number' },
      { id: 'avgCell', label: 'Avg Cell', default: false, sortKey: 'averageCellVoltage', sortType: 'number' },
      { id: 'cellDiff', label: 'Cell Diff', default: true, sortKey: 'cellVoltageDifference', sortType: 'number' },
      { id: 'temps', label: 'Temperatures', default: true, sortKey: 'temperature_1', sortType: 'number' },
      { id: 'mosTemp', label: 'MOS Temp', default: false, sortKey: 'mosTemperature', sortType: 'number' },
      { id: 'chargeMos', label: 'Charge MOS', default: false, sortKey: 'chargeMosOn', sortType: 'boolean' },
      { id: 'dischargeMos', label: 'Discharge MOS', default: false, sortKey: 'dischargeMosOn', sortType: 'boolean' },
      { id: 'balance', label: 'Balance', default: false, sortKey: 'balanceOn', sortType: 'boolean' },
      { id: 'solar', label: 'Solar (W/m¬≤)', default: true, sortKey: 'solar_ghi', sortType: 'number' },
      { id: 'weather', label: 'Weather', default: false, sortKey: 'weather_temp', sortType: 'number' },
      { id: 'model', label: 'Model', default: false, sortKey: 'model_used', sortType: 'string' },
      { id: 'cost', label: 'Cost', default: false, sortKey: 'cost_usd', sortType: 'number' },
      { id: 'status', label: 'Status', default: true, sortKey: 'status', sortType: 'string' }
    ];

    let visibleColumns = {};

    // Sorting state
    let currentSortColumn = 'time';
    let currentSortDirection = 'desc'; // 'asc' or 'desc'
    let currentRecords = []; // Store records for sorting

    // Load column settings from localStorage
    function loadColumnSettings() {
      const saved = localStorage.getItem('bms-column-visibility');
      if (saved) {
        try {
          visibleColumns = JSON.parse(saved);
        } catch (e) {
          resetColumnSettings(false);
        }
      } else {
        resetColumnSettings(false);
      }
    }

    // Save column settings to localStorage
    function saveColumnSettings() {
      // Read values from checkboxes
      ALL_COLUMNS.forEach(col => {
        const checkbox = document.getElementById(`col-${col.id}`);
        if (checkbox) {
          visibleColumns[col.id] = checkbox.checked;
        }
      });
      localStorage.setItem('bms-column-visibility', JSON.stringify(visibleColumns));
      alert('Column settings saved!');
      // Refresh history to apply changes
      if (document.getElementById('history-tab').classList.contains('active')) {
        refreshHistory();
      }
    }

    // Reset to default column settings
    function resetColumnSettings(showAlert = true) {
      visibleColumns = {};
      ALL_COLUMNS.forEach(col => {
        visibleColumns[col.id] = col.default;
      });
      localStorage.setItem('bms-column-visibility', JSON.stringify(visibleColumns));
      renderColumnToggles();
      if (showAlert) {
        alert('Column settings reset to defaults!');
        if (document.getElementById('history-tab').classList.contains('active')) {
          refreshHistory();
        }
      }
    }

    // Reanalysis functions
    async function checkReanalysisStatus() {
      try {
        const response = await fetch('/api/reanalysis/status');
        const data = await response.json();

        const statusDiv = document.getElementById('reanalysis-status');
        if (statusDiv) {
          if (data.needsReanalysis > 0) {
            statusDiv.innerHTML = `
              <div style="margin-bottom: 10px;">
                <strong style="color: var(--warning);">‚ö†Ô∏è ${data.needsReanalysis} of ${data.total} records need re-analysis (${data.percentage}%)</strong>
              </div>
              <div style="font-size: 0.9em; color: var(--text-secondary);">
                <div>‚Ä¢ Missing temperatures: ${data.breakdown.missingTemperatures}</div>
                <div>‚Ä¢ Missing MOS temp: ${data.breakdown.missingMosTemperature}</div>
                <div>‚Ä¢ Missing cell voltages: ${data.breakdown.missingCellVoltages}</div>
              </div>
            `;
          } else {
            statusDiv.innerHTML = `
              <div style="color: var(--success);">
                <strong>‚úÖ All ${data.total} records have complete extraction data</strong>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Reanalysis status error:', error);
        const statusDiv = document.getElementById('reanalysis-status');
        if (statusDiv) {
          statusDiv.innerHTML = `<span style="color: var(--error);">Error checking status: ${error.message}</span>`;
        }
      }
    }

    async function runReanalysis() {
      const btn = document.getElementById('reanalysis-run-btn');
      if (!btn) return;

      // Check status first
      const statusResponse = await fetch('/api/reanalysis/status');
      const status = await statusResponse.json();

      if (status.needsReanalysis === 0) {
        alert('All records already have complete extraction data!');
        return;
      }

      const count = Math.min(10, status.needsReanalysis);
      if (!confirm(`Re-analyze ${count} records with missing data? (${status.needsReanalysis} total remaining)`)) {
        return;
      }

      btn.disabled = true;
      btn.textContent = '‚è≥ Processing...';

      try {
        const response = await fetch('/api/reanalysis/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ limit: 10 })
        });

        const result = await response.json();

        if (result.success) {
          alert(`Re-analysis complete!\n\nProcessed: ${result.processed}\nErrors: ${result.errors}\nRemaining: ${result.remaining}`);
          // Refresh status and history
          checkReanalysisStatus();
          refreshHistory();
        } else {
          alert('Re-analysis failed: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Re-analysis error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Run Re-Analysis';
      }
    }

    // Render column toggle checkboxes in settings
    function renderColumnToggles() {
      const container = document.getElementById('column-toggles');
      if (!container) return;

      container.innerHTML = ALL_COLUMNS.map(col => `
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: var(--bg-card); border-radius: 6px;">
          <input type="checkbox" id="col-${col.id}" ${visibleColumns[col.id] ? 'checked' : ''} style="width: 18px; height: 18px;">
          <span>${col.label}</span>
        </label>
      `).join('');
    }

    // Check if a column is visible
    function isColumnVisible(colId) {
      return visibleColumns[colId] !== false;
    }

    // Sorting functions
    function sortRecords(records, columnId, direction) {
      const colConfig = ALL_COLUMNS.find(c => c.id === columnId);
      if (!colConfig) return records;

      const sortKey = colConfig.sortKey;
      const sortType = colConfig.sortType;

      return [...records].sort((a, b) => {
        let aVal = a[sortKey];
        let bVal = b[sortKey];

        // Handle null/undefined - always sort to end
        if (aVal === null || aVal === undefined || aVal === '') {
          return direction === 'asc' ? 1 : -1;
        }
        if (bVal === null || bVal === undefined || bVal === '') {
          return direction === 'asc' ? -1 : 1;
        }

        // Handle special case for time - use timestampFromFilename or timestamp
        if (columnId === 'time') {
          aVal = a.timestampFromFilename || a.timestamp;
          bVal = b.timestampFromFilename || b.timestamp;
        }

        let comparison = 0;
        if (sortType === 'number') {
          comparison = parseFloat(aVal) - parseFloat(bVal);
        } else if (sortType === 'date') {
          comparison = new Date(aVal) - new Date(bVal);
        } else {
          comparison = String(aVal).localeCompare(String(bVal));
        }

        return direction === 'asc' ? comparison : -comparison;
      });
    }

    function handleSort(columnId) {
      if (currentSortColumn === columnId) {
        // Toggle direction
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortColumn = columnId;
        currentSortDirection = 'asc';
      }

      // Re-render with sorted data
      if (currentRecords.length > 0) {
        const sorted = sortRecords(currentRecords, currentSortColumn, currentSortDirection);
        renderHistoryTable(sorted, true); // true = preserve sort state
      }
    }

    // Initialize column settings
    loadColumnSettings();

    // Tab switching
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');

        if (tab.dataset.tab === 'history') {
          refreshHistory();
        } else if (tab.dataset.tab === 'settings') {
          loadSettings();
        }
      });
    });

    // Load models on startup
    async function loadModels() {
      try {
        const response = await fetch('/api/models');
        const data = await response.json();
        models = data.models;
        selectedModel = data.defaultModel;

        // Load saved settings to get user's selected model
        const settingsResponse = await fetch('/api/settings');
        const settings = await settingsResponse.json();
        if (settings.selectedModel) {
          selectedModel = settings.selectedModel;
        }

        renderModelGrid();
        updateCostEstimate();
        populateModelDropdown();
      } catch (error) {
        console.error('Failed to load models:', error);
      }
    }

    function renderModelGrid() {
      const grid = document.getElementById('model-grid');
      grid.innerHTML = models.map(model => `
        <div class="model-option ${model.id === selectedModel ? 'selected' : ''} ${model.recommended ? 'recommended' : ''}"
             onclick="selectModel('${model.id}')">
          <div class="model-name">${model.name}</div>
          <div class="model-desc">${model.description}</div>
        </div>
      `).join('');
    }

    function selectModel(modelId) {
      selectedModel = modelId;
      renderModelGrid();
      updateCostEstimate();
    }

    async function updateCostEstimate() {
      try {
        const response = await fetch(`/api/estimate/${selectedModel}`);
        const data = await response.json();

        document.getElementById('cost-per-image').textContent = data.estimatedCost.formatted;
        document.getElementById('cost-per-thousand').textContent = data.estimatedCost.perThousandImages;
      } catch (error) {
        console.error('Failed to get cost estimate:', error);
      }
    }

    function populateModelDropdown() {
      const select = document.getElementById('default-model');
      select.innerHTML = models.map(model =>
        `<option value="${model.id}" ${model.id === selectedModel ? 'selected' : ''}>
          ${model.name} - ${model.description}
        </option>`
      ).join('');
    }

    // File upload handling
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');

    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', () => {
      handleFiles(fileInput.files);
    });

    async function handleFiles(files) {
      for (const file of files) {
        await analyzeFile(file);
      }
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.className = 'status show ' + type;
      status.innerHTML = type === 'loading'
        ? '<span class="spinner"></span>' + message
        : message;
    }

    function hideStatus() {
      document.getElementById('status').classList.remove('show');
    }

    async function analyzeFile(file) {
      const isZip = file.name.toLowerCase().endsWith('.zip');

      // Show progress container for ZIP files
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressPercent = document.getElementById('progress-percent');
      const progressCount = document.getElementById('progress-count');
      const progressRate = document.getElementById('progress-rate');
      const progressEta = document.getElementById('progress-eta');
      const progressCost = document.getElementById('progress-cost');
      const progressPhase = document.getElementById('progress-phase');
      const progressTitle = document.getElementById('progress-title');

      if (isZip) {
        progressContainer.style.display = 'block';
        progressTitle.textContent = `Processing ${file.name}`;
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        progressCount.textContent = '0 / ?';
        progressRate.textContent = '--/sec';
        progressEta.textContent = 'ETA: --';
        progressCost.textContent = '$0.00';
        progressPhase.textContent = 'Starting...';
      }

      hideStatus();

      const formData = new FormData();
      formData.append('image', file);

      try {
        // Use SSE streaming endpoint
        const response = await fetch('/api/analyze-stream', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let finalData = null;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });

          // Parse SSE events
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const event = JSON.parse(line.slice(6));
                handleSSEEvent(event, {
                  progressContainer, progressBar, progressPercent,
                  progressCount, progressRate, progressEta,
                  progressCost, progressPhase, progressTitle
                });

                if (event.type === 'complete') {
                  finalData = event;
                } else if (event.type === 'error') {
                  throw new Error(event.message);
                }
              } catch (parseErr) {
                console.warn('SSE parse error:', parseErr);
              }
            }
          }
        }

        // Handle final results
        if (finalData) {
          if (isZip) {
            const msg = `‚úÖ Complete: ${finalData.processed} new, ${finalData.updated || 0} updated, ${finalData.skipped} skipped. Cost: $${finalData.totalCost}`;
            showStatus(msg, 'success');
            showZipResultsFromSSE(finalData);
          } else if (finalData.duplicate) {
            progressContainer.style.display = 'none';
            showStatus('‚ö†Ô∏è This screenshot was already analyzed', 'duplicate');
          } else {
            progressContainer.style.display = 'none';
            const costMsg = finalData.totalCost ? ` (Cost: $${finalData.totalCost})` : '';
            showStatus('‚úÖ Analysis complete!' + costMsg, 'success');
          }
        }

      } catch (error) {
        console.error('Analysis error:', error);
        progressContainer.style.display = 'none';
        showStatus('‚ùå ' + (error.message || 'Unknown error occurred'), 'error');
      }
    }

    function handleSSEEvent(event, ui) {
      // Console log all SSE events for debugging
      console.log(`[SSE] ${event.type}:`, event);

      switch (event.type) {
        case 'init':
          console.log(`[Frontend] Initialized: ${event.total} images`);
          ui.progressCount.textContent = `0 / ${event.total}`;
          ui.progressPhase.textContent = event.message || 'Initializing...';
          break;

        case 'phase':
          console.log(`[Frontend] Phase: ${event.phase} - ${event.message}`);
          ui.progressPhase.textContent = event.message || event.phase;
          break;

        case 'precheck-complete':
          // ‚òÖ PROMINENT PRE-CHECK DISPLAY
          console.log(`[Frontend] ‚òÖ PRE-CHECK COMPLETE ‚òÖ`);
          console.log(`[Frontend]   Known-good (skipping): ${event.knownGood}`);
          console.log(`[Frontend]   New images: ${event.newImages}`);
          console.log(`[Frontend]   Needs re-analysis: ${event.needsReanalysis}`);

          // Show pre-check results prominently
          ui.progressTitle.textContent = `Pre-check: ${event.knownGood} already complete ‚úì`;
          ui.progressPhase.innerHTML = `<strong style="color: #22c55e;">‚úì ${event.knownGood} known-good records (skipping)</strong><br>` +
            `${event.newImages} new ‚Ä¢ ${event.needsReanalysis} re-analyze`;
          ui.progressPercent.textContent = `${event.knownGood}/${event.total}`;

          // If everything is already complete, show special message
          if (event.newImages === 0 && event.needsReanalysis === 0) {
            ui.progressBar.style.width = '100%';
            ui.progressBar.style.background = 'linear-gradient(90deg, #22c55e, #16a34a)';
            ui.progressPhase.innerHTML = `<strong style="color: #22c55e;">‚úì All ${event.knownGood} records already complete!</strong><br>Nothing to process.`;
          }
          break;

        case 'filter-complete':
          console.log(`[Frontend] Filter: ${event.toProcess} to process, ${event.skipped} skipped, ${event.invalid} invalid`);
          ui.progressPhase.textContent = `${event.toProcess} to process, ${event.skipped} complete records skipped`;
          ui.progressCount.textContent = `0 / ${event.toProcess}`;
          break;

        case 'progress':
          ui.progressBar.style.width = event.percent + '%';
          ui.progressPercent.textContent = event.percent + '%';
          ui.progressCount.textContent = `${event.completed} / ${event.total}`;
          ui.progressRate.textContent = `${event.rate}/sec`;
          ui.progressEta.textContent = `ETA: ${formatEta(event.eta)}`;
          ui.progressCost.textContent = `$${parseFloat(event.cost).toFixed(4)}`;

          // Log every 10th progress update to reduce console spam
          if (event.completed % 10 === 0 || event.completed === event.total) {
            console.log(`[Frontend] Progress: ${event.completed}/${event.total} (${event.percent}%) - ${event.rate}/sec`);
          }
          break;

        case 'complete':
          console.log(`[Frontend] ‚òÖ COMPLETE ‚òÖ ${event.processed} processed, ${event.skipped} skipped in ${event.totalTime}s`);
          ui.progressBar.style.width = '100%';
          ui.progressPercent.textContent = '100%';
          ui.progressPhase.textContent = `Done in ${event.totalTime}s (${event.rate} img/sec)`;
          break;

        case 'error':
          console.error(`[Frontend] ERROR: ${event.message}`);
          break;

        default:
          console.log(`[Frontend] Unknown event type: ${event.type}`, event);
      }
    }

    function formatEta(seconds) {
      if (!seconds || seconds < 0) return '--';
      if (seconds < 60) return `${seconds}s`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
      return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
    }

    function showZipResultsFromSSE(data) {
      const container = document.getElementById('result-container');

      let html = `
        <div class="result-card">
          <div class="result-header">
            <h3>üì¶ Processing Complete</h3>
            <span class="badge normal">${data.processed + (data.updated || 0)} analyzed</span>
          </div>
          <div class="metrics-grid">
            <div class="metric">
              <div class="metric-label">Total Images</div>
              <div class="metric-value">${data.totalImages}</div>
            </div>
            <div class="metric">
              <div class="metric-label">New Records</div>
              <div class="metric-value positive">${data.processed}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Updated</div>
              <div class="metric-value">${data.updated || 0}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Skipped (Complete)</div>
              <div class="metric-value">${data.skipped}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Errors</div>
              <div class="metric-value ${data.errors > 0 ? 'negative' : ''}">${data.errors}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Time</div>
              <div class="metric-value">${data.totalTime}s</div>
            </div>
          </div>
          <div class="cost-info">
            <span>Total API Cost: <strong>$${data.totalCost}</strong></span>
            <span>Rate: <strong>${data.rate} img/sec</strong></span>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    function showZipResults(data) {
      const container = document.getElementById('result-container');

      let html = `
        <div class="result-card">
          <div class="result-header">
            <h3>üì¶ ZIP Processing Results</h3>
            <span class="badge normal">${data.processed} processed</span>
          </div>
          <div class="metrics-grid">
            <div class="metric">
              <div class="metric-label">Total Images</div>
              <div class="metric-value">${data.totalImages}</div>
            </div>
            <div class="metric">
              <div class="metric-label">New Records</div>
              <div class="metric-value positive">${data.processed}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Duplicates Skipped</div>
              <div class="metric-value">${data.duplicates}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Errors</div>
              <div class="metric-value ${data.errors > 0 ? 'negative' : ''}">${data.errors}</div>
            </div>
          </div>
          <div class="cost-info">
            <span>Total API Cost: <strong>${data.totalCost.formatted}</strong></span>
          </div>
        </div>
      `;

      // Show individual results
      data.results.forEach(r => {
        if (r.success) {
          html += `<div class="result-card" style="padding: 15px;">
            <strong>${r.fileName}</strong> - ${r.record.hardwareSystemId || 'Unknown'} - SOC: ${r.record.stateOfCharge?.toFixed(1)}%
          </div>`;
        } else if (r.duplicate) {
          html += `<div class="result-card" style="padding: 15px; opacity: 0.6;">
            <strong>${r.fileName}</strong> - Duplicate (skipped)
          </div>`;
        } else if (r.error) {
          html += `<div class="result-card" style="padding: 15px; border-left: 3px solid var(--error);">
            <strong>${r.fileName}</strong> - Error: ${r.error}
          </div>`;
        }
      });

      container.innerHTML = html;
    }

    function showResult(record, cost) {
      const container = document.getElementById('result-container');

      const currentClass = record.current < 0 ? 'negative' : 'positive';
      const powerClass = record.power < 0 ? 'negative' : 'positive';

      let alertsHtml = '';
      if (record.alerts && record.alerts.length > 0) {
        alertsHtml = '<div class="alerts-list">' +
          record.alerts.map(a => {
            const type = a.includes('CRITICAL') ? 'critical' : 'warning';
            return `<div class="alert-item ${type}">${a}</div>`;
          }).join('') +
          '</div>';
      }

      let costHtml = '';
      if (cost) {
        costHtml = `
          <div class="cost-info">
            <span>Model: <strong>${record.model_used || selectedModel}</strong></span>
            <span>Tokens: <strong>${cost.input + cost.output}</strong></span>
            <span>Cost: <strong>${cost.formatted}</strong></span>
          </div>
        `;
      }

      container.innerHTML = `
        <div class="result-card">
          <div class="result-header">
            <h3>üìä ${record.hardwareSystemId || 'Unknown System'}</h3>
            <span class="badge ${(record.status || 'normal').toLowerCase()}">${record.status || 'Normal'}</span>
          </div>

          <div class="metrics-grid">
            <div class="metric">
              <div class="metric-label">State of Charge</div>
              <div class="metric-value">${record.stateOfCharge?.toFixed(1) || '0'}%</div>
            </div>
            <div class="metric">
              <div class="metric-label">Voltage</div>
              <div class="metric-value">${record.overallVoltage?.toFixed(2) || '0'}V</div>
            </div>
            <div class="metric">
              <div class="metric-label">Current</div>
              <div class="metric-value ${currentClass}">${record.current?.toFixed(2) || '0'}A</div>
            </div>
            <div class="metric">
              <div class="metric-label">Power</div>
              <div class="metric-value ${powerClass}">${record.power?.toFixed(1) || '0'}W</div>
            </div>
            <div class="metric">
              <div class="metric-label">Remaining Capacity</div>
              <div class="metric-value">${record.remainingCapacity?.toFixed(1) || '0'}Ah</div>
            </div>
            <div class="metric">
              <div class="metric-label">Cycle Count</div>
              <div class="metric-value">${record.cycleCount || '0'}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Cell Difference</div>
              <div class="metric-value">${((record.cellVoltageDifference || 0) * 1000).toFixed(1)}mV</div>
            </div>
            <div class="metric">
              <div class="metric-label">Temperature</div>
              <div class="metric-value">${record.temperatures?.[0] || record.temperature_1 || '-'}¬∞C</div>
            </div>
          </div>

          ${alertsHtml}
          ${costHtml}

          <div style="margin-top: 20px; color: var(--text-secondary); font-size: 0.85rem;">
            <strong>File:</strong> ${record.fileName} |
            <strong>Time:</strong> ${new Date(record.timestampFromFilename || record.timestamp).toLocaleString()}
            ${record.timestampFromFilename ? ' <span style="color: var(--success);">(from filename)</span>' : ''}
            ${record.weather_temp ? ` | <strong>Weather:</strong> ${record.weather_temp}¬∞C, ${record.weather_condition}, ‚òÅ${record.weather_clouds}%` : ''}
            ${record.solar_ghi ? ` | <strong>Solar:</strong> ‚òÄÔ∏è${Math.round(record.solar_ghi)} W/m¬≤ (GHI)` : ''}
          </div>
        </div>
      `;
    }

    async function refreshHistory(backfillWeather = false) {
      const container = document.getElementById('history-container');

      try {
        // Optionally backfill missing weather data first
        if (backfillWeather) {
          container.innerHTML = `
            <div class="empty-state">
              <span class="spinner"></span>
              <h3>Checking for missing weather/solar data...</h3>
            </div>
          `;

          try {
            const backfillResponse = await fetch('/api/backfill-weather', { method: 'POST' });
            const backfillResult = await backfillResponse.json();

            if (backfillResult.updated > 0) {
              console.log(`Backfilled ${backfillResult.updated} records with weather/solar data`);
            }
          } catch (backfillError) {
            console.warn('Weather backfill failed:', backfillError.message);
          }
        }

        const response = await fetch('/api/history');
        const records = await response.json();

        if (records.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <h3>No data yet</h3>
              <p>Upload some BMS screenshots to get started</p>
            </div>
          `;
          return;
        }

        // Data integrity check - look for obvious issues
        const integrityIssues = [];
        for (const r of records) {
          // Check if System ID looks like a filename (data shift indicator)
          if (r.hardwareSystemId && (r.hardwareSystemId.includes('.png') || r.hardwareSystemId.includes('.jpg') || r.hardwareSystemId.includes('Screenshot'))) {
            integrityIssues.push(`Record ${r.id?.substring(0, 8) || 'unknown'}: System ID contains filename - possible column shift`);
          }
          // Check if model contains weather data
          if (r.model_used && (r.model_used.includes('Clouds') || r.model_used.includes('Clear') || r.model_used.includes('Rain'))) {
            integrityIssues.push(`Record ${r.id?.substring(0, 8) || 'unknown'}: Model field contains weather data - possible column shift`);
          }
        }

        let warningHtml = '';
        if (integrityIssues.length > 0) {
          console.warn('Data integrity issues detected:', integrityIssues);
          warningHtml = `
            <div class="alert-item warning" style="margin-bottom: 15px;">
              ‚ö†Ô∏è Data integrity issues detected (${integrityIssues.length} records). CSV may need migration.
              <br><small>Check console for details. Try restarting the server to trigger auto-migration.</small>
            </div>
          `;
        }

        // Store records for sorting and render with sorting
        currentRecords = records;
        const sortedRecords = sortRecords(records, currentSortColumn, currentSortDirection);

        container.innerHTML = warningHtml + `
          <div style="margin-bottom: 10px; font-size: 0.85rem; color: var(--text-secondary);">
            ${sortedRecords.length} records | Sorted by: <strong>${ALL_COLUMNS.find(c => c.id === currentSortColumn)?.label || currentSortColumn}</strong> (${currentSortDirection === 'asc' ? 'ascending' : 'descending'}) | Click column headers to sort
          </div>
          <table class="history-table" id="history-table">
            <thead>
              <tr>
                ${getVisibleHeaders()}
              </tr>
            </thead>
            <tbody id="history-tbody">
              ${sortedRecords.map(r => generateTableRow(r)).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        container.innerHTML = `<div class="empty-state"><h3>Error loading history</h3><p>${error.message}</p></div>`;
      }
    }

    async function exportCSV() {
      window.location.href = '/api/export';
    }

    async function loadSettings() {
      try {
        const response = await fetch('/api/settings');
        const settings = await response.json();

        // Update status badges
        document.getElementById('gemini-status').className =
          'key-status ' + (settings.hasGeminiKey ? 'configured' : 'missing');
        document.getElementById('gemini-status').innerHTML =
          settings.hasGeminiKey ? '‚úÖ Configured' : '‚ùå Not configured';

        document.getElementById('weather-status').className =
          'key-status ' + (settings.hasWeatherKey ? 'configured' : 'missing');
        document.getElementById('weather-status').innerHTML =
          settings.hasWeatherKey ? '‚úÖ Configured' : '‚ùå Not configured';

        // Set location
        document.getElementById('latitude').value = settings.latitude || '';
        document.getElementById('longitude').value = settings.longitude || '';

        // Set default model
        if (settings.selectedModel) {
          document.getElementById('default-model').value = settings.selectedModel;
        }

        // Get CSV path
        const pathResponse = await fetch('/api/csv-path');
        const pathData = await pathResponse.json();
        document.getElementById('csv-path').value = pathData.path;

        // Render column visibility toggles
        renderColumnToggles();

      } catch (error) {
        console.error('Failed to load settings:', error);
      }
    }

    async function saveGeminiKey() {
      const key = document.getElementById('gemini-key').value.trim();
      if (!key) {
        alert('Please enter a Gemini API key');
        return;
      }

      try {
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ geminiApiKey: key })
        });

        if (response.ok) {
          document.getElementById('gemini-key').value = '';
          loadSettings();
          alert('Gemini API key saved!');
        } else {
          const data = await response.json();
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function deleteGeminiKey() {
      if (!confirm('Are you sure you want to delete the Gemini API key?')) return;

      try {
        await fetch('/api/settings/gemini', { method: 'DELETE' });
        loadSettings();
        alert('Gemini API key deleted');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function saveWeatherKey() {
      const key = document.getElementById('weather-key').value.trim();
      if (!key) {
        alert('Please enter a Weather API key');
        return;
      }

      try {
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ weatherApiKey: key })
        });

        if (response.ok) {
          document.getElementById('weather-key').value = '';
          loadSettings();
          alert('Weather API key saved!');
        } else {
          const data = await response.json();
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function deleteWeatherKey() {
      if (!confirm('Are you sure you want to delete the Weather API key?')) return;

      try {
        await fetch('/api/settings/weather', { method: 'DELETE' });
        loadSettings();
        alert('Weather API key deleted');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function saveDefaultModel() {
      const model = document.getElementById('default-model').value;

      try {
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ selectedModel: model })
        });

        if (response.ok) {
          selectedModel = model;
          renderModelGrid();
          updateCostEstimate();
          alert('Default model saved!');
        } else {
          const data = await response.json();
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function saveLocation() {
      const lat = parseFloat(document.getElementById('latitude').value);
      const lon = parseFloat(document.getElementById('longitude').value);

      if (isNaN(lat) || isNaN(lon)) {
        alert('Please enter valid coordinates');
        return;
      }

      try {
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ latitude: lat, longitude: lon })
        });

        if (response.ok) {
          alert('Location saved!');
        } else {
          const data = await response.json();
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // ========================================
    // Background Refresh System (SSE-based)
    // ========================================

    let refreshEventSource = null;
    let refreshInProgress = false;

    function startBackgroundRefresh() {
      if (refreshInProgress) {
        console.log('Refresh already in progress');
        return;
      }

      // Show the status bar
      const statusBar = document.getElementById('refresh-status-bar');
      statusBar.classList.remove('hidden');

      // Reset all phases to pending
      document.querySelectorAll('.refresh-phase').forEach(phase => {
        phase.classList.remove('active', 'complete', 'error');
        const icon = phase.querySelector('.refresh-phase-icon');
        icon.textContent = '‚óã';
      });

      // Reset progress
      document.getElementById('refresh-progress-fill').style.width = '0%';
      document.getElementById('refresh-status-message').textContent = 'Starting background refresh...';

      // Hide actions, show abort button
      document.getElementById('refresh-complete-actions').style.display = 'none';

      // Connect to SSE stream
      refreshEventSource = new EventSource('/api/refresh-stream');

      refreshEventSource.onopen = function() {
        console.log('SSE connection opened');
      };

      refreshEventSource.addEventListener('connected', function(e) {
        console.log('SSE connected:', JSON.parse(e.data));
        // Start the refresh
        fetch('/api/refresh-start', { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            if (!data.success) {
              showRefreshError(data.message || 'Failed to start refresh');
            } else {
              refreshInProgress = true;
            }
          })
          .catch(err => {
            showRefreshError('Failed to start refresh: ' + err.message);
          });
      });

      refreshEventSource.addEventListener('phase', function(e) {
        const data = JSON.parse(e.data);
        updateRefreshPhase(data.phase, data.status, data.message);
      });

      refreshEventSource.addEventListener('progress', function(e) {
        const data = JSON.parse(e.data);
        updateRefreshProgress(data.current, data.total, data.message);
      });

      refreshEventSource.addEventListener('records', function(e) {
        const data = JSON.parse(e.data);
        // Full records update - render the table
        renderHistoryTable(data.records);
        document.getElementById('refresh-status-message').textContent =
          `Loaded ${data.records.length} records`;
      });

      refreshEventSource.addEventListener('record-update', function(e) {
        const data = JSON.parse(e.data);
        // Update a single row in-place
        updateTableRow(data.record);
      });

      refreshEventSource.addEventListener('complete', function(e) {
        const data = JSON.parse(e.data);
        completeRefresh(data);
      });

      refreshEventSource.addEventListener('error', function(e) {
        if (e.data) {
          const data = JSON.parse(e.data);
          showRefreshError(data.error || 'Unknown error');
        }
      });

      refreshEventSource.onerror = function(e) {
        console.error('SSE error:', e);
        if (refreshEventSource.readyState === EventSource.CLOSED) {
          showRefreshError('Connection lost');
        }
      };
    }

    function updateRefreshPhase(phaseName, status, message) {
      const phaseEl = document.querySelector(`.refresh-phase[data-phase="${phaseName}"]`);
      if (!phaseEl) return;

      // Remove all status classes
      phaseEl.classList.remove('active', 'complete', 'error');

      const icon = phaseEl.querySelector('.refresh-phase-icon');

      if (status === 'active' || status === 'running') {
        phaseEl.classList.add('active');
        icon.innerHTML = '<span class="spinner-small"></span>';
      } else if (status === 'complete' || status === 'done') {
        phaseEl.classList.add('complete');
        icon.textContent = '‚úì';
      } else if (status === 'error') {
        phaseEl.classList.add('error');
        icon.textContent = '‚úó';
      } else if (status === 'skipped') {
        phaseEl.classList.add('complete');
        icon.textContent = '‚Äî';
      }

      if (message) {
        document.getElementById('refresh-status-message').textContent = message;
      }
    }

    function updateRefreshProgress(current, total, message) {
      const pct = total > 0 ? Math.round((current / total) * 100) : 0;
      document.getElementById('refresh-progress-fill').style.width = pct + '%';

      if (message) {
        document.getElementById('refresh-status-message').textContent = message;
      }
    }

    function completeRefresh(data) {
      refreshInProgress = false;

      // Close SSE connection
      if (refreshEventSource) {
        refreshEventSource.close();
        refreshEventSource = null;
      }

      // Mark all phases complete
      document.querySelectorAll('.refresh-phase').forEach(phase => {
        if (!phase.classList.contains('error')) {
          phase.classList.remove('active');
          phase.classList.add('complete');
          const icon = phase.querySelector('.refresh-phase-icon');
          if (icon.innerHTML.includes('spinner')) {
            icon.textContent = '‚úì';
          }
        }
      });

      // Update progress to 100%
      document.getElementById('refresh-progress-fill').style.width = '100%';

      // Show completion message with summary
      let summary = 'Refresh complete!';
      if (data.summary) {
        const s = data.summary;
        summary = `Done! ${s.totalRecords || 0} records`;
        if (s.migrated) summary += ' (migrated)';
        if (s.weatherUpdated > 0) summary += `, ${s.weatherUpdated} weather updates`;
      }
      document.getElementById('refresh-status-message').textContent = summary;

      // Update status bar title to show completion
      document.querySelector('.refresh-status-title').innerHTML = '‚úÖ Refresh Complete';

      // Show dismiss action
      document.getElementById('refresh-complete-actions').style.display = 'flex';
    }

    function showRefreshError(message) {
      refreshInProgress = false;

      if (refreshEventSource) {
        refreshEventSource.close();
        refreshEventSource = null;
      }

      document.getElementById('refresh-status-message').textContent = '‚ùå ' + message;
      document.querySelector('.refresh-status-title').innerHTML = '‚ùå Refresh Error';
      document.getElementById('refresh-complete-actions').style.display = 'flex';
    }

    function hideRefreshStatus() {
      const statusBar = document.getElementById('refresh-status-bar');
      statusBar.classList.add('hidden');

      // Reset title
      document.querySelector('.refresh-status-title').innerHTML = '<span class="spinner-small"></span> Refreshing Data';

      // Abort if still in progress
      if (refreshInProgress) {
        abortRefresh();
      }
    }

    function abortRefresh() {
      fetch('/api/refresh-abort', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          console.log('Refresh aborted:', data);
          refreshInProgress = false;
          if (refreshEventSource) {
            refreshEventSource.close();
            refreshEventSource = null;
          }
        })
        .catch(err => console.error('Abort failed:', err));
    }

    function getSortIndicator(colId) {
      if (currentSortColumn !== colId) return '';
      return currentSortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
    }

    function getVisibleHeaders() {
      const headers = [];
      ALL_COLUMNS.forEach(col => {
        if (isColumnVisible(col.id)) {
          const indicator = getSortIndicator(col.id);
          const isActive = currentSortColumn === col.id;
          headers.push(`<th onclick="handleSort('${col.id}')" style="cursor: pointer; user-select: none;${isActive ? ' background: var(--accent); color: white;' : ''}" title="Click to sort">${col.label}${indicator}</th>`);
        }
      });
      return headers.join('');
    }

    function renderHistoryTable(records, preserveSort = false) {
      const container = document.getElementById('history-container');

      if (!records || records.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No data yet</h3>
            <p>Upload some BMS screenshots to get started</p>
          </div>
        `;
        return;
      }

      // Store records for sorting (use original unsorted if not preserving)
      if (!preserveSort) {
        currentRecords = records;
      }

      // Apply current sort
      const sortedRecords = sortRecords(records, currentSortColumn, currentSortDirection);

      container.innerHTML = `
        <div style="margin-bottom: 10px; font-size: 0.85rem; color: var(--text-secondary);">
          ${sortedRecords.length} records | Sorted by: <strong>${ALL_COLUMNS.find(c => c.id === currentSortColumn)?.label || currentSortColumn}</strong> (${currentSortDirection === 'asc' ? 'ascending' : 'descending'}) | Click column headers to sort
        </div>
        <table class="history-table" id="history-table">
          <thead>
            <tr>
              ${getVisibleHeaders()}
            </tr>
          </thead>
          <tbody id="history-tbody">
            ${sortedRecords.map(r => generateTableRow(r)).join('')}
          </tbody>
        </table>
      `;
    }

    /**
     * Format timestamp for display WITHOUT timezone conversion
     * Preserves local time sovereignty - if filename says 13:09:50, display 13:09:50
     */
    function formatTimestamp(timestamp) {
      if (!timestamp) return '-';
      // Parse our local format: "2026-01-26T13:09:50" -> "1/26/2026, 1:09:50 PM"
      const match = timestamp.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
      if (match) {
        const [, year, month, day, hour, min, sec] = match;
        const h = parseInt(hour, 10);
        const ampm = h >= 12 ? 'PM' : 'AM';
        const hour12 = h % 12 || 12;
        return `${parseInt(month, 10)}/${parseInt(day, 10)}/${year}, ${hour12}:${min}:${sec} ${ampm}`;
      }
      // Fallback for UTC timestamps (legacy data with Z suffix)
      if (timestamp.endsWith('Z')) {
        return new Date(timestamp).toLocaleString();
      }
      return timestamp;
    }

    function generateTableRow(r) {
      const displayTime = r.timestampFromFilename || r.timestamp;
      const soc = parseFloat(r.stateOfCharge) || 0;
      const voltage = parseFloat(r.overallVoltage) || 0;
      const current = parseFloat(r.current) || 0;
      const power = parseFloat(r.power) || 0;
      const remaining = parseFloat(r.remainingCapacity) || 0;
      const full = parseFloat(r.fullCapacity) || 0;
      const cycles = parseInt(r.cycleCount) || 0;
      const highCell = parseFloat(r.highestCellVoltage) || 0;
      const lowCell = parseFloat(r.lowestCellVoltage) || 0;
      const avgCell = parseFloat(r.averageCellVoltage) || 0;
      const cellDiff = parseFloat(r.cellVoltageDifference) || 0;
      const mosTemp = parseFloat(r.mosTemperature);
      const solarGhi = parseFloat(r.solar_ghi) || 0;
      const solarDni = parseFloat(r.solar_dni) || 0;
      const solarDhi = parseFloat(r.solar_dhi) || 0;
      const weatherTemp = parseFloat(r.weather_temp);
      const weatherClouds = parseFloat(r.weather_clouds) || 0;
      const costUsd = parseFloat(r.cost_usd);

      // Build temperature display
      const temps = [r.temperature_1, r.temperature_2, r.temperature_3, r.temperature_4]
        .filter(t => t !== null && t !== undefined && t !== '')
        .map(t => parseFloat(t))
        .filter(t => !isNaN(t));
      const tempDisplay = temps.length > 0 ? temps.map(t => t + '¬∞').join(' / ') : '-';

      const cells = [];
      if (isColumnVisible('time')) cells.push(`<td title="${r.timestampFromFilename ? 'From filename' : 'Upload time'}">${formatTimestamp(displayTime)}</td>`);
      if (isColumnVisible('systemId')) cells.push(`<td>${r.hardwareSystemId || '-'}</td>`);
      if (isColumnVisible('fileName')) cells.push(`<td style="font-size: 0.75rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${r.fileName || ''}">${r.fileName || '-'}</td>`);
      if (isColumnVisible('soc')) cells.push(`<td>${soc.toFixed(1)}%</td>`);
      if (isColumnVisible('voltage')) cells.push(`<td>${voltage.toFixed(2)}V</td>`);
      if (isColumnVisible('current')) cells.push(`<td style="color: ${current < 0 ? 'var(--error)' : 'var(--success)'}">${current.toFixed(2)}A</td>`);
      if (isColumnVisible('power')) cells.push(`<td style="color: ${power < 0 ? 'var(--error)' : 'var(--success)'}">${power.toFixed(1)}W</td>`);
      if (isColumnVisible('capacity')) cells.push(`<td style="font-size: 0.8rem;">${remaining.toFixed(1)}${full > 0 ? '/' + full.toFixed(0) : ''}Ah</td>`);
      if (isColumnVisible('cycles')) cells.push(`<td>${cycles}</td>`);
      if (isColumnVisible('highCell')) cells.push(`<td style="font-size: 0.8rem;">${highCell > 0 ? highCell.toFixed(3) + 'V' : '-'}</td>`);
      if (isColumnVisible('lowCell')) cells.push(`<td style="font-size: 0.8rem;">${lowCell > 0 ? lowCell.toFixed(3) + 'V' : '-'}</td>`);
      if (isColumnVisible('avgCell')) cells.push(`<td style="font-size: 0.8rem;">${avgCell > 0 ? avgCell.toFixed(3) + 'V' : '-'}</td>`);
      if (isColumnVisible('cellDiff')) cells.push(`<td style="font-size: 0.8rem;">${(cellDiff * 1000).toFixed(1)}mV</td>`);
      if (isColumnVisible('temps')) cells.push(`<td style="font-size: 0.75rem;">${tempDisplay}</td>`);
      if (isColumnVisible('mosTemp')) cells.push(`<td style="font-size: 0.8rem;">${!isNaN(mosTemp) ? mosTemp + '¬∞' : '-'}</td>`);
      if (isColumnVisible('chargeMos')) cells.push(`<td style="font-size: 0.8rem;">${r.chargeMosOn ? 'üü¢' : '‚ö™'}</td>`);
      if (isColumnVisible('dischargeMos')) cells.push(`<td style="font-size: 0.8rem;">${r.dischargeMosOn ? 'üü¢' : '‚ö™'}</td>`);
      if (isColumnVisible('balance')) cells.push(`<td style="font-size: 0.8rem;">${r.balanceOn ? 'üü¢' : '‚ö™'}</td>`);
      if (isColumnVisible('solar')) cells.push(`<td style="font-size: 0.8rem; color: var(--warning);" title="GHI: ${solarGhi} | DNI: ${solarDni} | DHI: ${solarDhi}">${solarGhi ? `‚òÄÔ∏è${Math.round(solarGhi)}` : '-'}</td>`);
      if (isColumnVisible('weather')) cells.push(`<td style="font-size: 0.8rem;">${!isNaN(weatherTemp) ? `${weatherTemp}¬∞C ${r.weather_condition || ''} ‚òÅ${weatherClouds}%` : '-'}</td>`);
      if (isColumnVisible('model')) cells.push(`<td style="font-size: 0.8rem;">${(r.model_used || '-').replace('gemini-', '')}</td>`);
      if (isColumnVisible('cost')) cells.push(`<td style="color: var(--success); font-size: 0.8rem;">${!isNaN(costUsd) ? '$' + costUsd.toFixed(6) : '-'}</td>`);
      if (isColumnVisible('status')) cells.push(`<td><span class="badge ${(r.status || 'normal').toLowerCase()}">${r.status || 'Normal'}</span></td>`);

      return `<tr data-record-id="${r.id}">${cells.join('')}</tr>`;
    }

    function updateTableRow(record) {
      const row = document.querySelector(`tr[data-record-id="${record.id}"]`);
      if (row) {
        // Replace the row content
        row.outerHTML = generateTableRow(record);

        // Flash the row to indicate update
        const newRow = document.querySelector(`tr[data-record-id="${record.id}"]`);
        if (newRow) {
          newRow.style.transition = 'background-color 0.5s';
          newRow.style.backgroundColor = 'rgba(34, 197, 94, 0.2)';
          setTimeout(() => {
            newRow.style.backgroundColor = '';
          }, 1000);
        }
      }
    }

    // Initial load
    loadModels();
    loadSettings();
    checkReanalysisStatus();
  </script>

  <!-- Refresh Status Bar (fixed position, bottom-right) -->
  <div id="refresh-status-bar" class="refresh-status-bar hidden">
    <div class="refresh-status-header">
      <div class="refresh-status-title">
        <span class="spinner-small"></span> Refreshing Data
      </div>
      <button class="refresh-status-close" onclick="hideRefreshStatus()" title="Dismiss">&times;</button>
    </div>

    <div class="refresh-status-phases">
      <div class="refresh-phase" data-phase="migration">
        <span class="refresh-phase-icon">‚óã</span>
        <span>Validate & repair data</span>
      </div>
      <div class="refresh-phase" data-phase="reload">
        <span class="refresh-phase-icon">‚óã</span>
        <span>Reload & display records</span>
      </div>
      <div class="refresh-phase" data-phase="weather">
        <span class="refresh-phase-icon">‚óã</span>
        <span>Backfill weather & solar data</span>
      </div>
    </div>

    <div class="refresh-progress-bar">
      <div class="refresh-progress-fill" id="refresh-progress-fill" style="width: 0%"></div>
    </div>

    <div class="refresh-status-message" id="refresh-status-message">
      Initializing...
    </div>

    <div class="refresh-status-actions" id="refresh-complete-actions" style="display: none;">
      <button class="btn btn-secondary" onclick="hideRefreshStatus()">Dismiss</button>
    </div>
  </div>
</body>
</html>
