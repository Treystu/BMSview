// @ts-nocheck
/**
 * Create GitHub Issue Endpoint
 * Auto-generates GitHub issues from AI feedback
 */

const { createLogger } = require('./utils/logger.cjs');
const { getCollection } = require('./utils/mongodb.cjs');
const { getCorsHeaders } = require('./utils/cors.cjs');

/**
 * Format feedback as GitHub issue
 */
function formatGitHubIssue(feedback) {
  const priorityEmoji = {
    critical: 'ðŸ”´',
    high: 'ðŸŸ ',
    medium: 'ðŸŸ¡',
    low: 'âšª'
  };
  
  const categoryEmoji = {
    weather_api: 'ðŸŒ¤ï¸',
    data_structure: 'ðŸ—„ï¸',
    ui_ux: 'ðŸŽ¨',
    performance: 'âš¡',
    integration: 'ðŸ”Œ',
    analytics: 'ðŸ“Š'
  };
  
  const title = `${priorityEmoji[feedback.priority]} ${categoryEmoji[feedback.category]} ${feedback.suggestion.title}`;
  
  const body = `
## AI-Generated Feedback

**Type:** ${feedback.feedbackType.replace('_', ' ')}  
**Category:** ${feedback.category.replace('_', ' ')}  
**Priority:** ${feedback.priority.toUpperCase()}  
**Generated by:** ${feedback.geminiModel}  
**System ID:** ${feedback.systemId}

---

### Description

${feedback.suggestion.description}

### Rationale

${feedback.suggestion.rationale}

### Expected Benefit

${feedback.suggestion.expectedBenefit}

### Implementation Details

${feedback.suggestion.implementation}

**Estimated Effort:** ${feedback.suggestion.estimatedEffort}

${feedback.suggestion.affectedComponents && feedback.suggestion.affectedComponents.length > 0 ? `
### Affected Components

${feedback.suggestion.affectedComponents.map(comp => `- ${comp}`).join('\n')}
` : ''}

${feedback.suggestion.codeSnippets && feedback.suggestion.codeSnippets.length > 0 ? `
### Suggested Code

\`\`\`javascript
${feedback.suggestion.codeSnippets.join('\n\n')}
\`\`\`
` : ''}

---

*This issue was automatically generated from AI feedback on ${new Date(feedback.timestamp).toLocaleDateString()}*  
*Feedback ID: ${feedback.id}*
`;

  const labels = [
    'ai-generated',
    `priority-${feedback.priority}`,
    `category-${feedback.category}`,
    feedback.feedbackType
  ];

  return { title, body, labels };
}

/**
 * Create GitHub issue (mock implementation - would integrate with GitHub API)
 */
async function createGitHubIssueAPI(issueData) {
  // NOTE: This is a mock implementation
  // In production, this would call the GitHub API:
  // const response = await fetch('https://api.github.com/repos/Treystu/BMSview/issues', {
  //   method: 'POST',
  //   headers: {
  //     'Authorization': `token ${process.env.GITHUB_TOKEN}`,
  //     'Accept': 'application/vnd.github.v3+json'
  //   },
  //   body: JSON.stringify(issueData)
  // });
  
  // For now, return mock data
  const mockIssueNumber = Math.floor(Math.random() * 1000) + 300;
  
  return {
    number: mockIssueNumber,
    url: `https://github.com/Treystu/BMSview/issues/${mockIssueNumber}`,
    html_url: `https://github.com/Treystu/BMSview/issues/${mockIssueNumber}`,
    state: 'open',
    created_at: new Date().toISOString()
  };
}

/**
 * Main handler
 */
exports.handler = async (event, context) => {
  const log = createLogger('create-github-issue', context);
  const headers = getCorsHeaders(event);
  
  // Handle preflight
  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers };
  }
  
  try {
    if (event.httpMethod !== 'POST') {
      return {
        statusCode: 405,
        headers: { ...headers, 'Content-Type': 'application/json' },
        body: JSON.stringify({ error: 'Method not allowed' })
      };
    }
    
    const body = JSON.parse(event.body);
    const { feedbackId, feedback } = body;
    
    if (!feedbackId && !feedback) {
      return {
        statusCode: 400,
        headers: { ...headers, 'Content-Type': 'application/json' },
        body: JSON.stringify({ error: 'Either feedbackId or feedback is required' })
      };
    }
    
    // Get feedback from database if only ID provided
    let feedbackData = feedback;
    if (feedbackId && !feedback) {
      const feedbackCollection = await getCollection('ai_feedback');
      feedbackData = await feedbackCollection.findOne({ id: feedbackId });
      
      if (!feedbackData) {
        return {
          statusCode: 404,
          headers: { ...headers, 'Content-Type': 'application/json' },
          body: JSON.stringify({ error: 'Feedback not found' })
        };
      }
      
      // Check if already has GitHub issue
      if (feedbackData.githubIssue) {
        return {
          statusCode: 409,
          headers: { ...headers, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            error: 'GitHub issue already exists for this feedback',
            githubIssue: feedbackData.githubIssue
          })
        };
      }
    }
    
    log.info('Creating GitHub issue for AI feedback', {
      feedbackId: feedbackData.id,
      priority: feedbackData.priority
    });
    
    // Format issue
    const issueData = formatGitHubIssue(feedbackData);
    
    // Create GitHub issue
    const githubIssue = await createGitHubIssueAPI(issueData);
    
    // Update feedback with GitHub issue info
    if (feedbackId) {
      const feedbackCollection = await getCollection('ai_feedback');
      await feedbackCollection.updateOne(
        { id: feedbackId },
        {
          $set: {
            githubIssue: {
              number: githubIssue.number,
              url: githubIssue.html_url,
              status: githubIssue.state
            },
            updatedAt: new Date()
          }
        }
      );
    }
    
    log.info('GitHub issue created successfully', {
      feedbackId: feedbackData.id,
      issueNumber: githubIssue.number
    });
    
    return {
      statusCode: 200,
      headers: { ...headers, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        success: true,
        issueNumber: githubIssue.number,
        issueUrl: githubIssue.html_url,
        feedbackId: feedbackData.id
      })
    };
  } catch (error) {
    log.error('Create GitHub issue error', { error: error.message, stack: error.stack });
    return {
      statusCode: 500,
      headers: { ...headers, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        error: 'Failed to create GitHub issue',
        message: error.message
      })
    };
  }
};

// Export for testing
module.exports.formatGitHubIssue = formatGitHubIssue;
