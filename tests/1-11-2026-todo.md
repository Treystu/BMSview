Fix production test suite stub and skip bug
Tasks:
Replace stubbed pass-through tests with real assertions for DB connectivity (Mongo mock), API endpoints (analyze, generate-insights, weather/solar/system-analytics), Gemini mock, and multi-tenant behaviors.
Fix skipped counter typo (results.summary.skipped++) @tests/production-test-suite.js#47-59.
Add coverage thresholds to Jest config and wire into CI.
Acceptance:
npm test passes locally with mocks; CI enforces coverage gate.
Failing endpoint or auth misuse causes test failures.
Skip counter increments correctly when tests are filtered.
Add service mocks and integration test harness
Tasks:
Provide mocks for Gemini, Netlify weather/solar/system-analytics, and Mongo (extend tests/mocks).
Add env flag to toggle real vs mocked services; default to mocked in CI.
Write integration tests for async analysis flow, upload flow, caching/polling, and admin diagnostics.
Acceptance:
Tests run offline by default; optional real-service run is documented.
Async analysis and upload flows are covered end-to-end with assertions on state/UI.
Consolidate weather/solar/system analytics callers
Tasks:
Choose a single helper (prefer Netlify-aware) to call weather/solar/system analytics with consistent base URL resolution (process.env.URL/SITE_URL → localhost fallback), headers, auth, retries/backoff, and structured error normalization.
Remove or alias duplicate implementations in gemini-tools.cjs vs tool-executor.cjs.
Add contract tests for these helpers.
Acceptance:
One exported helper used by all call sites; no divergent base-URL logic.
Helper retries transient 5xx/ECONNRESET and logs duration/status.
Tests cover success, 4xx, 5xx, and missing param validation.
Implement predictive maintenance endpoint and tools
Tasks:
Add netlify/functions/predictive-maintenance.js with initial rule/linear degradation model and typed response DTO.
Implement tool functions: getWeatherData, getSolarEstimate, getSystemAnalytics (or route through consolidated helper), predict_battery_trends, analyze_usage_patterns, calculate_energy_budget.
Add unit tests and tool-executor integration tests.
Acceptance:
Endpoint returns deterministic JSON with health score, degradation slope, and alert flags.
Tool executor can call all listed tools with validation; bad params return 400-style errors.
Tests cover happy path and validation failures.
Upload pipeline improvements
Tasks:
Create dedicated upload Netlify function supporting chunked uploads with resumable IDs, size limit, checksum validation.
Enhance UploadSection UI: progress bars, drag-and-drop, cancel/retry, error states; emit upload progress to state.
Add tests for chunking, resume, and oversize rejection.
Acceptance:
Files > limit are rejected with clear message; chunked uploads complete and assemble.
UI shows progress, allows cancel/retry, and reflects errors.
Tests cover resume after network drop.
Insights & predictive UI
Tasks:
Build components/BatteryInsights.tsx with trend charts, anomalies, predictive overlays; integrate predictive-maintenance API and analytics tools.
Extend admin insights dashboard with solar/weather correlation and system analytics panels; include loading/error/empty states.
Acceptance:
Charts render with mocked data in tests; empty/error states visible.
Predictive data displays degradation and forecast windows consistently.
Multi-tenancy audit and protections
Tasks:
Audit all Netlify functions (analyze, generate-insights, uploads, diagnostics, analytics) for userId/tenant scoping in queries and responses.
Ensure auth context propagation from client; add guards on write/update paths.
Add integration tests to verify isolation (user A cannot read/write B’s data).
Acceptance:
All DB queries include tenant filter when userId present; backwards-compatible when absent.
Tests prove isolation; any missing userId returns 401/403 or safe fallback as designed.
Data-quality computations
Tasks:
Implement sunrise/sunset via lat/lon (e.g., sun calc), hourly averaging, and performance baselines in analytics pipeline.
Add unit tests for time zones/DST and missing timestamps.
Acceptance:
Functions return correct values in tests across multiple geos/timezones.
Analytics surfaces these computed fields; no crashes on missing data.
Code quality and legacy cleanup
Tasks:
Retire legacy proxies (e.g., generate-insights vs generate-insights-with-tools) once routes are migrated; remove dead/commented code.
Add lint rule to fail on new TODO/FIXME without owner/tag.
Update docs to reflect live endpoints and testing strategy.
Acceptance:
No unused legacy entrypoints; imports/build succeed.
Lint fails on untagged TODO/FIXME; docs match current APIs.
Operational hardening
Tasks:
Add structured logging with request IDs and timing around key functions (analyze, upload, insights).
Add rate limiting and input validation on public endpoints (upload, weather/solar proxies).
Acceptance:
Logs include requestId, duration, and status for each invocation.
Rate limit and validation tested: bad inputs and over-limit calls return clear errors.