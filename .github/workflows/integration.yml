name: Integration & E2E Tests

on:
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [ main, master, 'claude/**' ]
  schedule:
    # Run daily at 3am UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  e2e-critical-flows:
    name: End-to-End Critical Flows
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        flow:
          - screenshot-upload-analysis
          - system-registration
          - insights-generation
          - data-export

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ${{ matrix.flow }} E2E test
        run: |
          case "${{ matrix.flow }}" in
            screenshot-upload-analysis)
              npm test -- tests/bms-screenshot-extraction-e2e.test.js
              ;;
            system-registration)
              npm test -- --testPathPattern="tests/.*system.*" --testNamePattern="registration|create"
              ;;
            insights-generation)
              npm test -- tests/insights-generation.simple.test.js
              ;;
            data-export)
              npm test -- tests/export-data.test.js
              ;;
          esac
        env:
          CI: true
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

  database-integration:
    name: Database Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database integration tests
        run: npm test -- --testPathPattern="integration" --maxWorkers=2
        env:
          CI: true
          MONGODB_URI: ${{ secrets.MONGODB_URI }}

  api-integration:
    name: API Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Test Weather API integration
        run: |
          node -e "
          const { handler } = require('./netlify/functions/weather.cjs');
          const event = {
            httpMethod: 'POST',
            body: JSON.stringify({
              lat: 40.7128,
              lon: -74.0060,
              timestamp: new Date().toISOString()
            })
          };
          handler(event).then(result => {
            console.log('Weather API response:', result);
            if (result.statusCode !== 200) {
              console.error('Weather API test failed');
              process.exit(1);
            }
            const data = JSON.parse(result.body);
            if (!data.temp && !data.error) {
              console.error('Invalid weather data structure');
              process.exit(1);
            }
            console.log('✅ Weather API integration working');
          }).catch(err => {
            console.error('Weather API test failed:', err);
            process.exit(1);
          });
          "
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        continue-on-error: true

      - name: Test Gemini API integration
        run: |
          node -e "
          const { GeminiClient } = require('./netlify/functions/utils/geminiClient.cjs');
          const client = new GeminiClient({ apiKey: process.env.GEMINI_API_KEY || 'test' });

          // Test simple prompt
          const testPrompt = {
            text: 'Return only the number 42, nothing else.'
          };

          client.callAPI(testPrompt, { model: 'gemini-1.5-flash-8b' }).then(result => {
            console.log('Gemini API response:', result);
            console.log('✅ Gemini API integration working');
          }).catch(err => {
            if (err.message.includes('API key') || err.message.includes('unavailable')) {
              console.log('ℹ️ Gemini API not available in test environment (expected)');
            } else {
              console.error('Unexpected Gemini API error:', err);
              process.exit(1);
            }
          });
          "
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        continue-on-error: true

  cache-sync-integration:
    name: Cache & Sync Integration
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run sync integration tests
        run: npm test -- tests/syncManager.integration.test.js tests/frontend-sync.e2e.test.js
        env:
          CI: true

  duplicate-detection-integration:
    name: Duplicate Detection Integration
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run duplicate detection tests
        run: |
          npm test -- tests/duplicate-detection.test.js \
                       tests/duplicate-flow-integration.test.js \
                       tests/check-duplicates-batch.test.js \
                       tests/hash-consistency.test.js
        env:
          CI: true

  data-pipeline-integration:
    name: Data Pipeline Integration
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run pipeline integration tests
        run: |
          npm test -- tests/integration-pipeline.test.js \
                       tests/data-aggregation.test.js \
                       tests/comprehensive-analytics.test.js
        env:
          CI: true
          MONGODB_URI: ${{ secrets.MONGODB_URI }}

  regression-tests:
    name: Regression Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run regression test suite
        run: |
          npm test -- tests/extraction-mandatory-fields.test.js \
                       tests/extraction-quality-validation.test.js \
                       tests/data-validation.test.js \
                       tests/autonomous-self-correction.test.js
        env:
          CI: true

  integration-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs:
      - e2e-critical-flows
      - database-integration
      - api-integration
      - cache-sync-integration
      - duplicate-detection-integration
      - data-pipeline-integration
      - regression-tests
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "### Integration & E2E Test Results :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.e2e-critical-flows.result }}" == "success" ]; then
            echo "✅ E2E Critical Flows: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ E2E Critical Flows: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.database-integration.result }}" == "success" ]; then
            echo "✅ Database Integration: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Database Integration: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.api-integration.result }}" == "success" ]; then
            echo "✅ API Integration: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ API Integration: Check logs" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.cache-sync-integration.result }}" == "success" ]; then
            echo "✅ Cache & Sync: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Cache & Sync: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.duplicate-detection-integration.result }}" == "success" ]; then
            echo "✅ Duplicate Detection: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Duplicate Detection: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.data-pipeline-integration.result }}" == "success" ]; then
            echo "✅ Data Pipeline: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Data Pipeline: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.regression-tests.result }}" == "success" ]; then
            echo "✅ Regression Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Regression Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All integration and E2E tests completed." >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical integration tests failed
        if: |
          needs.e2e-critical-flows.result == 'failure' ||
          needs.duplicate-detection-integration.result == 'failure' ||
          needs.regression-tests.result == 'failure'
        run: |
          echo "❌ Critical integration tests failed"
          exit 1
