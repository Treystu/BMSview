# BMSview Data Model & Variable Master List

This document serves as the single source of truth for the variable naming conventions and data model used across the BMSview application. The goal is to unify terminology, specifically regarding System IDs and Hardware Identifiers, to prevent confusion and ensuring consistent linking.

---

## ⚠️ CRITICAL: Two Types of Identifiers

There are **TWO distinct identifier concepts** in BMSview. Confusing them causes linking failures:

### 1. System ID (`systemId`) — The Database Reference
- **What it is**: A UUID generated by the database when a user registers/creates a system profile
- **Purpose**: Links analysis records to user-defined system profiles
- **Example**: `"550e8400-e29b-41d4-a716-446655440000"`
- **Found in**: `BmsSystem.id`, `AnalysisRecord.systemId`

### 2. Hardware ID (`hardwareSystemId`) — The Physical Device Identifier
- **What it is**: The identifier extracted from the BMS device screenshot (e.g., "DL-12345")
- **Purpose**: Identifies which physical BMS device the data came from
- **Example**: `"DL-12345"`, `"BT-A789"`, `"SN20241201"`
- **Found in**: `AnalysisRecord.hardwareSystemId`, `BmsSystem.associatedHardwareIds[]`

### How They Relate
```
BmsSystem (User's registered system profile)
├── id: "550e8400-..."              ← systemId (database UUID)
├── name: "My Van Battery"          ← Human-readable name
└── associatedHardwareIds: ["DL-12345", "DL-12346"]  ← Physical device IDs

AnalysisRecord (Single screenshot analysis)
├── id: "abc123..."                 ← Record's unique ID
├── systemId: "550e8400-..."        ← Links to BmsSystem.id
├── hardwareSystemId: "DL-12345"    ← Physical device this came from
└── analysis: { ... }               ← Extracted BMS data
```

### Common Confusion Points
| What you might call it | Correct field name | WRONG field (deprecated) |
|------------------------|-------------------|--------------------------|
| "The DL number from the screen" | `hardwareSystemId` | ~~`dlNumber`~~ |
| "The system's hardware IDs" | `associatedHardwareIds` | ~~`associatedDLs`~~ |
| "Which system this record belongs to" | `systemId` | N/A |

---

## 1. Core Concepts

### 1.1. System Entity (`BmsSystem`)

Represents a configured battery system (e.g., "Main Van Battery").

- **Unique Identifier**: `id` (UUID v4). This is the internal primary key used for relationships in the database.
  - _Variable Name_: `systemId` (when referencing a system), `id` (on the system object itself).
- **Hardware Identifiers**: A system can be associated with one or more physical devices.
  - **primary field**: `associatedHardwareIds` (Array of strings).
  - **legacy field (DEPRECATED)**: `associatedDLs` (Array of strings). Do not use in new code.
  - _Rule_: `associatedHardwareIds` is the Source of Truth.

### 1.2. Analysis Record (`AnalysisRecord`)

Represents a single parsed BMS screenshot or data point.

- **Unique Identifier**: `id` (UUID v4 or MongoDB ObjectId).
- **Link to System**:
  - `systemId`: The UUID of the `BmsSystem` this record belongs to.
- **Hardware Source ID**: The identifier extracted from the image/upload that identifies the physical device.
  - **primary field**: `hardwareSystemId` (String).
  - **legacy field (DEPRECATED)**: `dlNumber` (String). Do not use in new code.
  - _Rule_: `hardwareSystemId` is the Source of Truth. If a legacy record is updated, migrate `dlNumber` to `hardwareSystemId`.

## 2. Variable Dictionary

| Variable / Field Name   | Context         | Type          | Definition / Usage                                                                                                                                       |
| :---------------------- | :-------------- | :------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `systemId`              | Global          | UUID (String) | The primary key of a System in the `systems` collection. Used in `history` records to link them to a system. **This is NOT the hardware serial number.** |
| `hardwareSystemId`      | Analysis Record | String        | The physical identifier (e.g., "DL12345", "BT-A789") extracted from the device screen. Used to look up the correct `systemId`.                           |
| `dlNumber`              | Analysis Record | String        | **DEPRECATED**. Legacy field. Do not use. Use `hardwareSystemId`.                                                                                        |
| `associatedHardwareIds` | System Entity   | String[]      | List of physical IDs (like `hardwareSystemId`) that belong to this system. **Source of Truth**.                                                          |
| `associatedDLs`         | System Entity   | String[]      | **DEPRECATED**. Legacy field. Do not use. Use `associatedHardwareIds`.                                                                                   |
| `fileName`              | Analysis Record | String        | The original filename of the uploaded screenshot.                                                                                                        |
| `analysis`              | Analysis Record | Object        | Contains the raw data extracted from Gemini (e.g., voltage, current, SOC).                                                                               |
| `weather`               | Analysis Record | Object        | Contains weather data associated with the record's timestamp and location.                                                                               |
| `timestamp`             | Global          | ISO String    | The time the record occurred (UTC).                                                                                                                      |

## 3. Unification Rules (The "Forever" Rules)

1. **Always use `systemId` for Relations**: When linking a record to a system in the database, frontend, or API, ALWAYS use the System's UUID (`systemId`). Never link using the hardware ID string directly as a foreign key.
2. **Hardware ID Source of Truth**:
   - ALWAYS read/write to `hardwareSystemId` on records.
   - ALWAYS read/write to `associatedHardwareIds` on Systems.
   - **Do not** explicitly populate `dlNumber` or `associatedDLs` in new code. The backend may maintain them for temporary backwards compatibility, but they are dead fields.
3. **Auto-Association Priority**:
   - First, try to match the record's `hardwareSystemId` against a System's `id` (Direct UUID match).
   - Second, try to match against the System's `associatedHardwareIds` list.
